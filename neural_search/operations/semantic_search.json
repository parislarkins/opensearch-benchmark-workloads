{
  "name": "semantic-search",
  "operation-type": "search",
  "variable-queries": {{variable_queries | default(0)}},
  "param-source": "neural-search-source",
  "nested":"{{nested}}",
  "index": "{{ index_name }}",
  "body": {
    "_source": {
      "includes": [
        "text"
      ]
    },
    "size": {{query_size | default(10)}},
    "query": {
      {%- if nested is defined and nested == true  %}
        "nested": {
          "path": "passage_chunk_embedding",
          "query": {
            "neural": {
              "passage_chunk_embedding.knn": {
                {%- if k is defined and k %}
                  "k": {{ k }},
                {%- elif min_score is defined and min_score %}
                  "min_score": {{ min_score }},
                {%- elif max_distance is defined and max_distance %}
                  "max_distance": {{ max_distance }},
                {%- endif %}

                "query_text": "What are some of the best science projects?",
                "model_id": ""
              }
            }
          }
        }
      {% else %}
        "neural": {
          "passage_embedding": {
            {%- if k is defined and k %}
              "k": {{ k }},
            {%- elif min_score is defined and min_score %}
              "min_score": {{ min_score }},
            {%- elif max_distance is defined and max_distance %}
              "max_distance": {{ max_distance }},
            {%- endif %}

            "query_text": "What are some of the best science projects?",
            "model_id": ""
          }
        }
      {% endif %}
    }
  }
},
{
   "name": "create-sagemaker-ml-connector",
   "operation-type": "create-ml-connector",
   "body": {
      "name": "{{ connector_name | default('Amazon Sagemaker Connector') }}",
      "description": "The connector to sagemaker models",
      "version": 1,
      "protocol": "aws_sigv4",
      "parameters": {
          "region": "{{ region }}",
          "service_name": "sagemaker"
      },
      "credential": {
          "access_key": "{{ access_key }}",
          "secret_key": "{{ secret_key }}",
          "session_token": "{{ session_token }}"
      },
      "actions": [
          {
              "action_type": "predict",
              "method": "POST",
              "url": "{{ sagemaker_endpoint_url }}",
              "headers": {
                  "content-type": "application/json",
                  "x-amz-content-sha256": "required"
              },
              "request_body": "${parameters.input}"
          }
      ]
  }
},
{
   "name": "delete-sagemaker-ml-connector",
   "operation-type": "delete-ml-connector",
   "connector_name": "{{ connector_name | default('Amazon sagemaker Connector') }}"
},
{
   "name": "register-sagemaker-remote-ml-model",
   "operation-type": "register-remote-ml-model",
   "body": {
      "name": "sagemaker neural search embedding model",
      "function_name": "remote",
      "description": "remote model for running neural semantic search benchmark"
   }
}